# Why not be more secure?

## Solution

### Determine the problem
Looking at the page code source, we find the following script:
```javascript
// Look's like weak JavaScript auth script :)
$(".c_submit").click(function(event) {
	event.preventDefault();
	var u = $("#cpass").val();
	var k = $("#cuser").val();
	var func = "\x2B\x09\x4A\x03\x49\x0F\x0E\x14\x15\x1A\x00\x10\x3F\x1A\x71\x5C\x5B\x5B\x00\x1A\x16\x38\x06\x46\x66\x5A\x55\x30\x0A\x03\x1D\x08\x50\x5F\x51\x15\x6B\x4F\x19\x56\x00\x54\x1B\x50\x58\x21\x1A\x0F\x13\x07\x46\x1D\x58\x58\x21\x0E\x16\x1F\x06\x5C\x1D\x5C\x45\x27\x09\x4C\x1F\x07\x56\x56\x4C\x78\x24\x47\x40\x49\x19\x0F\x11\x1D\x17\x7F\x52\x42\x5B\x58\x1B\x13\x4F\x17\x26\x00\x01\x03\x04\x57\x5D\x40\x19\x2E\x00\x01\x17\x1D\x5B\x5C\x5A\x17\x7F\x4F\x06\x19\x0A\x47\x5E\x51\x59\x36\x41\x0E\x19\x0A\x53\x47\x5D\x58\x2C\x41\x0A\x04\x0C\x54\x13\x1F\x17\x60\x50\x12\x4B\x4B\x12\x18\x14\x42\x79\x4F\x1F\x56\x14\x12\x56\x58\x44\x27\x4F\x19\x56\x49\x16\x1B\x16\x14\x21\x1D\x07\x05\x19\x5D\x5D\x47\x52\x60\x46\x4C\x1E\x1D\x5F\x5F\x1C\x15\x7E\x0B\x0B\x00\x49\x51\x5F\x55\x44\x31\x52\x45\x13\x1B\x40\x5C\x46\x10\x7C\x38\x10\x19\x07\x55\x13\x44\x56\x31\x1C\x15\x19\x1B\x56\x13\x47\x58\x30\x1D\x1B\x58\x55\x1D\x57\x5D\x41\x7C\x4D\x4B\x4D\x49\x4F";
	buf = "";
	if(k.length == 9) {
		for(i = 0, j = 0; i < func.length; i++) {
			c = parseInt(func.charCodeAt(i));
			c = c ^ k.charCodeAt(j);
			if(++j == k.length) {
				j = 0;
			}
			buf += eval('"' + a(x(c)) + '"');
		}
		eval(buf);
	} else {
		$("#cresponse").html("<div class='alert alert-danger'>Wrong password sorry.</div>");
	}
});

function a(h) {
	if(h.length != 2) {
		h = "\x30" + h;
	}
	return "\x5c\x78" + h;
}

function x(d) {
	if(d < 0) {
		d = 0xFFFFFFFF + d + 1;
	}
	return d.toString(16).toUpperCase();
}
```

Reading the code, we find out that the username is used as a key of length 9 to generate a JavaScript code that will then be evaluated.

### Finding the key

Let's assume the key is made out of alphanumerical characters only (set of cardinality 36), it means there are approximatively at least `9^36 = 2 * 10^34` possible keys to try out. This is way too much to brute force for the machine we have in hand.

We can simplify the problem into a pure XOR function:
```
const func_simp = Array.from(func).map(x => parseInt(x.charCodeAt(0)))

function getCode(k) {
	return func_simp
	  .map((x, i) => func_simp[i] ^ k.charCodeAt(i%9))
	  .map(x => String.fromCharCode(x))
	  .join('');
}
```

#### Option 1: Guessing the key by trial

We can build a function that from the output string will build back the complete string, leaving blank space otherwise:
```
/* Adapt to support key with a length lower than 9, printing space otherwise */
function getCode(k) {
	return func_simp
	  // 32 for whitespace
	  .map((x, i) => i%9<k.length ? func_simp[i] ^ k.charCodeAt(i%9) : 32)
	  .map(x => String.fromCharCode(x))
	  .join('');
}

function getKeyFromCode(code) {
	return Array.from(code)
	  .map((x, i) => func_simp[i]^x.charCodeAt(0))
	  .map(x => String.fromCharCode(x))
	  .join('');
}

// we can build the full string based on the initial guess:
getCode(getKeyFromCode("something"))
```

We know the output is supposed to be ES5 JavaScript. We can try multiple possible beginning of code: `var `, `function`, `if (`, `if(`... Or looking at previous challenges we see there is supposed to be a condition such as `if(condition == "something")`. `if(` gives an interesting output.

Knowing the variable `u` hasn't been used yet, we find out that `if(u == "` gives the following output:

```
> getCode(getKeyFromCode('if(u == "'))
if(u == "XorIsCoolButNotUnbreakable") { if(document.location.href.indexOf("?p=") == -1) { document.location = document.location.href + "?p=" + u; } } else {  $("#cresponse").html("<div class='error'>Wrong password sorry.</div>"); }   
```

It would also have been possible to guess other pieces of the key by guessing other part of the output (not necessarily the beginning).

Thus the key is: `getKeyFromCode('if(u == "') = Bobvi2347`

#### Option 2: Using a XOR analyzer tool

TODO

#### Option 3: Deducting the key with probabilities

TODO

Therefore we enter the following:

|Field  | Value |
| ------------- | ------------- |
|username|Bobvi2347|
|password|XorIsCoolButNotUnbreakable|

And we obtain the Flag `FLAG-rhwMJNczASAJ4WgwfIA7fcJD`
